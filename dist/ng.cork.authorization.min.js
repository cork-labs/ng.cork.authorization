!function(a){"use strict";function b(a){return!!a&&h(a.then)}function c(a){return i(a)&&h(a[a.length-1])}function d(a,b){return a.replace(/:(\w+)/g,function(a,c){return a.replace(":"+c,b[c])})}var e=a.module("ng.cork.authorization",["ngRoute"]),f=a.isString,g=a.isObject,h=a.isFunction,i=a.isArray;e.factory("CorkAuthorizationError",[function(){var a=function(a){this.redirectPath=a};return a}]),e.provider("corkAuthorization",[function(){var e=this,j={defaultRedirectPath:"/"};e.configure=function(b){a.extend(j,b)},e.$authorizeRoute=["corkAuthorization",function(a){return a.$authorizeRoute()}];var k={};e.middleware=function(a,b){if(!f(a))throw new Error("Invalid corkAuthorization middleware name.");if(arguments.length>1){if(k[a])throw new Error('corkAuthorization middleware "'+a+'" is already registered.');if(!h(b)&&!c(b))throw new Error('Invalid corkAuthorization middleware "'+a+'".');return k[a]=b,e}if(!k[a])throw new Error('Unknown corkAuthorization middleware "'+a+'".');return k[a]},e.$get=["$rootScope","$q","$location","$route","CorkAuthorizationError",function(a,c,k,l,m){function n(a,d){var e,f,g=[];return a.forEach(function(a,i){if(!h(a))throw new Error("Invalid corkAuthorization rule in $$route.");e=a(d),b(e)?g.push(e):(f=c.defer(),g.push(f.promise),e?f.resolve():f.reject())}),c.all(g)}a.$on("$routeChangeError",function(a,b,c,e){var g;if(e instanceof m){var i=b.$$route,j=i.corkAuthorization,l=j&&j.onReject;if(f(e.redirectPath))g=e.redirectPath;else if(j.hasOwnProperty("onReject"))if(f(l))g=l;else{if(!h(l))throw new Error("Invald onReject handler. Must be an array or function.");g=l(i)}g||(g=c&&c.$$route?d(c.$$route.originalPath,c.params):"/"),k.path(g)}});var o=function(){var b=this,d={};b.middleware=function(a,c){var d=arguments.length>1?e.middleware(a,c):e.middleware(a);return d===e?b:d},b.$authorizeRoute=function(){var b=c.defer(),d=l.current,e=d.$$route,h=e.corkAuthorization;return g(h)&&i(h.rules)?(n(e.corkAuthorization.rules,e).then(function(a){b.resolve()},function(c){if(!c||f(c))c=new m(c);else if(!(c instanceof m))throw new Error("Invalid route rejection error. Must be string with redirectUrl or a CorkAuthorizationError object.");c.$$route=c.$$route=e,b.reject(c),a.$broadcast("corkAuthorization.rejected",c)}),b.promise):(b.resolve(),b.promise)},b.addAction=function(a,b){d[a]=b||[]},b.authorizeAction=function(a){if(!d[a])throw new Error('Unknown action "'+a+'".');return n(d[a])},b.allowedActions=function(a){var c={},d=function(){a.forEach(function(a){b.authorizeAction(a).then(function(){c[a]=!0},function(){delete c[a]})})};return c.$refresh=d,d(),c}};return Object.defineProperty(o.prototype,"defaultRedirectPath",{get:function(){return j.defaultRedirectPath}}),new o}]}])}(angular);